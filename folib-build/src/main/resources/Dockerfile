FROM  public.folib.com/public-project/docker/openjdk:17-jdk-slim-buster
MAINTAINER folib.com
ENV TZ=Asia/Shanghai
# 项目构建文件结构 环境变量
ENV RUN_WORKDIR=/opt/folib
ENV FOLIB_PORT="${FOLIB_PORT:-38080}"
ENV FOLIB_JVM_XMX="${FOLIB_JVM_XMX:-4096m}"
ENV FOLIB_JVM_XMS="${FOLIB_JVM_XMS:-4096m}"
ENV FOLIB_JVM_XSS="${FOLIB_JVM_XSS:-256k}"
ENV FOLIB_JVM_PARALLEL_GC_THREADS="${FOLIB_JVM_PARALLEL_GC_THREADS:-8}"
ENV FOLIB_JVM_MAX_DIRECT_MEMORY_SIZE="${FOLIB_JVM_MAX_DIRECT_MEMORY_SIZE:-4096m}"
ENV FOLIB_DB_PROFILE="${FOLIB_DB_PROFILE:-db_EMBEDDED}"
ENV FOLIB_GREMLIN_SERVER_ENABLED="${FOLIB_GREMLIN_SERVER_ENABLED:-false}"
ENV FOLIB_LOG_CONSOLE_ENABLED="${FOLIB_LOG_CONSOLE_ENABLED:-false}"
ENV FOLIB_LOG_FILE_ENABLED="${FOLIB_LOG_FILE_ENABLED:-true}"
ENV FOLIB_LOG_FILE_SIZE_SINGLE="${FOLIB_LOG_FILE_SIZE_SINGLE:-128MB}"
ENV FOLIB_LOG_FILE_SIZE_TOTAL="${FOLIB_LOG_FILE_SIZE_TOTAL:-1GB}"
ENV FOLIB_LOG_FILE_HISTORY="${FOLIB_LOG_FILE_HISTORY:-31}"
ENV FOLIB_DEBUG="${FOLIB_DEBUG:-false}"
ENV FOLIB_JETTY_LEVEL="${FOLIB_JETTY_LEVEL:-INFO}"
ENV FOLIB_NPM_REMOTE_CHANGES_ENABLED="${FOLIB_NPM_REMOTE_CHANGES_ENABLED:-false}"
ENV FOLIB_NUGET_DOWNLOAD_FEED="${FOLIB_NUGET_DOWNLOAD_FEED:-false}"
ENV FOLIB_DOWNLOAD_INDEXES="${FOLIB_DOWNLOAD_INDEXES:-false}"
ENV FOLIB_ES_HOST="${FOLIB_ES_HOST:-127.0.0.1}"
ENV FOLIB_MYSQL_HOST="${FOLIB_MYSQL_HOST:-127.0.0.1}"
ENV FOLIB_MYSQL_PORT="${FOLIB_MYSQL_PORT:-3306}"
ENV FOLIB_MYSQL_DB="${FOLIB_MYSQL_DB:-folib_scanner}"
ENV FOLIB_MYSQL_USER="${FOLIB_MYSQL_USER:-root}"
ENV FOLIB_MYSQL_PASSWORD="${FOLIB_MYSQL_PASSWORD:-199088926}"
ENV FOLIB_NVD="${FOLIB_NVD:-nvd.folib.com/feeds/json/cve/1.1}"
ENV FOLIB_JMX_PORT="${FOLIB_JMX_PORT:-7199}"
ENV FOLIB_DISTRIBUTED_LOCKIP="${FOLIB_DISTRIBUTED_LOCKIP:-127.0.0.1}"
ENV FOLIB_CLUSTER_OPENFLAG="${FOLIB_CLUSTER_OPENFLAG:-false}"
ENV FOLIB_CLUSTER_HOSTNODE="${FOLIB_CLUSTER_HOSTNODE:-http://127.0.0.1:38080}"
ENV FOLIB_REMOTE_DB_HOST="${FOLIB_REMOTE_DB_HOST:-127.0.0.1}"
ENV FOLIB_REMOTE_DB_PORT="${FOLIB_REMOTE_DB_PORT:-49142}"
ENV FOLIB_REMOTE_DB_USER="${FOLIB_REMOTE_DB_USER:-root}"
ENV FOLIB_REMOTE_DB_PASS="${FOLIB_REMOTE_DB_PASS:-folib-cassandra}"
ENV FOLIB_EMBEDDED_DB_HOST="${FOLIB_EMBEDDED_DB_HOST:-127.0.0.1}"
ENV FOLIB_CASSANDRA_LISTEN_ADDRESS="${FOLIB_CASSANDRA_LISTEN_ADDRESS:-127.0.0.1}"
ENV FOLIB_CASSANDRA_SEEDS="${FOLIB_CASSANDRA_SEEDS:-127.0.0.1}"
ENV FOLIB_CASSANDRA_GC_GRACE_SECONDS="${FOLIB_CASSANDRA_GC_GRACE_SECONDS:-864000}"
ENV FOLIB_S3_REGION="${FOLIB_S3_REGION:-folib}"
ENV FOLIB_S3_URI="${FOLIB_S3_URI:-s3://localhost:9000/}"
ENV FOLIB_S3_ACCESS_KEY="${FOLIB_S3_ACCESS_KEY:-folib}"
ENV FOLIB_S3_SECRET_KEY="${FOLIB_S3_SECRET_KEY:-folib}"
ENV FOLIB_PROMOTE_HOSTS="${FOLIB_PROMOTE_HOSTS:-}"
ENV FOLIB_PROMOTION_BLOCK="${FOLIB_PROMOTION_BLOCK:-false}"
ENV FOLIB_WEB_URL_PREFIX="${FOLIB_WEB_URL_PREFIX:-/ui/}"
ENV FOLIB_REDIS_ENABLED="${FOLIB_REDIS_ENABLED:-false}"
ENV FOLIB_REDIS_HOST="${FOLIB_REDIS_HOST:-127.0.0.1}"
ENV FOLIB_REDIS_PASSWORD="${FOLIB_REDIS_PASSWORD:-123456}"
#分布式内嵌缓存端口和集群地址
ENV FOLIB_CACHE_PORT="${FOLIB_CACHE_PORT:-5701}"
ENV FOLIB_CACHE_CLUSTER="${FOLIB_CACHE_CLUSTER:-127.0.0.1:5701}"
ENV FOLIB_SWAGGER_ENABLE="${FOLIB_SWAGGER_ENABLE:-false}"
ENV FOLIB_THREAD_POOL_COMMON_CORE="${FOLIB_THREAD_POOL_COMMON_CORE:-24}"
ENV FOLIB_THREAD_POOL_COMMON_MAX="${FOLIB_THREAD_POOL_COMMON_MAX:-24}"
ENV FOLIB_THREAD_POOL_COMMON_QUEUE="${FOLIB_THREAD_POOL_COMMON_QUEUE:-100000000}"
ENV FOLIB_THREAD_POOL_SCAN_CORE="${FOLIB_THREAD_POOL_SCAN_CORE:-2}"
ENV FOLIB_THREAD_POOL_SCAN_MAX="${FOLIB_THREAD_POOL_SCAN_MAX:-2}"
ENV FOLIB_THREAD_POOL_SCAN_QUEUE="${FOLIB_THREAD_POOL_SCAN_QUEUE:-12}"
ENV FOLIB_THREAD_POOL_EVENT_LOG_CORE="${FOLIB_THREAD_POOL_EVENT_LOG_CORE:-2}"
ENV FOLIB_THREAD_POOL_EVENT_LOG_MAX="${FOLIB_THREAD_POOL_EVENT_LOG_MAX:-2}"
ENV FOLIB_THREAD_POOL_EVENT_LOG_QUEUE="${FOLIB_THREAD_POOL_EVENT_LOG_QUEUE:-100}"
#晋级参数配置
ENV FOLIB_PROMOTION_WS_REQUEST_TIMOUT_OF_ARTIFACT_UPLOAD="${FOLIB_PROMOTION_WS_REQUEST_TIMOUT_OF_ARTIFACT_UPLOAD:-600}"
ENV FOLIB_PROMOTION_QUEUE_SIZE="${FOLIB_PROMOTION_QUEUE_SIZE:-1000}"
ENV FOLIB_PROMOTION_RETRY_COUNT="${FOLIB_PROMOTION_RETRY_COUNT:-3}"
ENV FOLIB_PROMOTION_WS_REQUEST_TIMOUT="${FOLIB_PROMOTION_WS_REQUEST_TIMOUT:-10}"
ENV FOLIB_PROMOTION_THREAD="${FOLIB_PROMOTION_THREAD:-2}"
#NPM日期格式化
ENV FOLIB_NPM_DATE_FORMAT="${NPM_DATE_FORMAT:-yyyy-MM-dd'T'HH:mm:ss.SSS'Z',yyyy-MM-dd'T'HH:mm:ss'Z'}"
#FoEyes
ENV FOLIB_THIRDPARTY_FOEYES_ENABLE="${FOLIB_THIRDPARTY_FOEYES_ENABLE:-false}"
ENV FOLIB_THIRDPARTY_FOEYES_BASEURL="${FOLIB_THIRDPARTY_FOEYES_BASEURL:-http://127.0.0.1:9527}"
ENV FOLIB_THIRDPARTY_FOEYES_ACCESS_KEY="${FOLIB_THIRDPARTY_FOEYES_ACCESS_KEY:-racdvMVzV9Wnqu8NAfQkyrsD0a2N0fNE}"
#gremlin相关配置
ENV FOLIB_THREAD_POOL_WORKER="${FOLIB_THREAD_POOL_WORKER:-16}"
ENV FOLIB_GREMLIN_POOL="${FOLIB_GREMLIN_POOL:-16}"
ENV FOLIB_MAX_WORK_QUEUE_SIZE="${FOLIB_MAX_WORK_QUEUE_SIZE:-16384}"
ENV FOLIB_MAX_SESSION_TASK_QUEUE_SIZE="${FOLIB_MAX_SESSION_TASK_QUEUE_SIZE:-8192}"
ENV FOLIB_MAX_CONTENT_LENGTH="${FOLIB_MAX_CONTENT_LENGTH:-1048576}"
ENV FOLIB_MAX_CHUNK_SIZE="${FOLIB_MAX_CHUNK_SIZE:-65536}"
ENV FOLIB_MAX_ACCUMULATION_BUFFER_COMPONENTS="${FOLIB_MAX_ACCUMULATION_BUFFER_COMPONENTS:-2048}"
ENV FOLIB_RESULT_ITERATION_BATCH_SIZE="${FOLIB_RESULT_ITERATION_BATCH_SIZE:-256}"
ENV FOLIB_USE_EPOLL_EVENT_LOOP="${FOLIB_USE_EPOLL_EVENT_LOOP:-true}"
ENV FOLIB_IDLE_CONNECTION_TIMEOUT="${FOLIB_IDLE_CONNECTION_TIMEOUT:-30000}"
ENV FOLIB_EVALUATION_TIMEOUT="${FOLIB_EVALUATION_TIMEOUT:-30000}"
ENV FOLIB_WRITE_BUFFER_HIGH_WATER_MARK="${FOLIB_WRITE_BUFFER_HIGH_WATER_MARK:-65536}"
ENV FOLIB_WRITE_BUFFER_LOW_WATER_MARK="${FOLIB_WRITE_BUFFER_LOW_WATER_MARK:-32768}"
#artifact上传限制开关
ENV FOLIB_ARTIFACT_UPLOAD_RESTRICTIONS="${FOLIB_ARTIFACT_UPLOAD_RESTRICTIONS:-false}"
#SSL相关配置
ENV FOLIB_HTTP_PORT="${FOLIB_HTTP_PORT:-}"
ENV FOLIB_SSL_ENABLED="${FOLIB_SSL_ENABLED:-false}"
ENV FOLIB_SSL_KEY_STORE="${FOLIB_SSL_KEY_STORE:-}"
ENV FOLIB_SSL_KEY_STORE_TYPE="${FOLIB_SSL_KEY_STORE_TYPE:-}"
ENV FOLIB_SSL_KEY_STORE_PASSWORD="${FOLIB_SSL_KEY_STORE_PASSWORD:-}"
ENV FOLIB_SSL_KEY_ALIAS="${FOLIB_SSL_KEY_ALIAS:-}"
ENV FOLIB_SSL_KEY_PASSWORD="${FOLIB_SSL_KEY_PASSWORD:-}"
ENV FOLIB_SSL_TRUST_STORE="${FOLIB_SSL_TRUST_STORE:-}"
ENV FOLIB_SSL_TRUST_STORE_PASSWORD="${FOLIB_SSL_TRUST_STORE_PASSWORD:-}"
ENV FOLIB_SSL_TRUST_STORE_TYPE="${FOLIB_SSL_TRUST_STORE_TYPE:-}"
ENV FOLIB_ARTIFACT_DOWNLOAD_IMMEDIATELY_UPDATE="${FOLIB_ARTIFACT_DOWNLOAD_IMMEDIATELY_UPDATE:-false}"
ENV FOLIB_DOCKER_BROWSE_COMPATIBILITY="${FOLIB_DOCKER_BROWSE_COMPATIBILITY:-false}"
ENV FOLIB_CUSTOM_MAX_IN_MEMORY_SIZE="${FOLIB_CUSTOM_MAX_IN_MEMORY_SIZE:-10240}"
ENV FOLIB_SEARCH_INDEX="${FOLIB_SEARCH_INDEX:-}"

RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
RUN mkdir ${RUN_WORKDIR} && chmod -R 777 ${RUN_WORKDIR}
COPY folib-3.0-SNAPSHOT ${RUN_WORKDIR}/folib-3.0-SNAPSHOT
COPY folib-data  ${RUN_WORKDIR}/folib-data
WORKDIR  ${RUN_WORKDIR}
VOLUME  ${RUN_WORKDIR}/folib-data/
EXPOSE ${FOLIB_PORT}
EXPOSE 7010
EXPOSE 7011
EXPOSE ${FOLIB_JMX_PORT}
EXPOSE 49142
EXPOSE 8182
ENTRYPOINT exec ${RUN_WORKDIR}/folib-3.0-SNAPSHOT/bin/folib console
