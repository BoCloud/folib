/*
 * Folib - [新一代AI制品仓库]
 * Copyright (C) 2025 bocloud.com.cn <folib@beyondcent.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * 本程序是自由软件：您可依据GNU通用公共许可证（GPL-3.0+）条款重新发布和修改，
 * 但禁止任何形式的商业售卖行为（包括但不限于：直接销售、捆绑销售、云服务商用）。
 *
 * This program is distributed WITHOUT ANY WARRANTY.
 * Commercial sale of this software is expressly prohibited.
 *
 * For license details, see: https://www.gnu.org/licenses/gpl-3.0.html
 * 商业授权咨询请联系：folib@beyondcent.com
 */
package com.folib.scanner.vulnerability.resolver;


import com.folib.scanner.vulnerability.ICweService;
import com.folib.scanner.vulnerability.SpringUtils;
import com.folib.scanner.vulnerability.model.Cwe;
import org.apache.commons.lang3.StringUtils;

import java.util.HashMap;
import java.util.Map;

/**
 * Attempts to resolve an internal CWE object from a string
 * representation of a CWE.
 *
 * @author Steve Springett
 * @since 3.0.0
 */

public class CweResolver {

    private static final ICweService qm;
    private static final Map<Integer, String> CWE_DICTIONARY = new HashMap<>();
    static {
        qm = SpringUtils.getBean(ICweService.class);
            for (final Cwe cwe : qm.getAllCwes()) {
                CWE_DICTIONARY.put(cwe.getCweId(), cwe.getName());
            }
    }
    private static final CweResolver INSTANCE = new CweResolver();

    private CweResolver() { }

    public static CweResolver getInstance() {
        return INSTANCE;
    }
    /**
     * Lookups a CWE from the internal CWE dictionary. This method
     * does not query the database, but will return a Cwe object useful
     * for JSON serialization, but not for persistence.
     * @param cweString the string to lookup
     * @return a Cwe object
     * @since 4.5.0
     */
    public Cwe lookup(final String cweString) {
        CWE_DICTIONARY.isEmpty();

        final Integer cweId = parseCweString(cweString);
        if (cweId != null) {
            final String cweName = CWE_DICTIONARY.get(cweId);
            if (cweName != null) {
                final Cwe cwe = new Cwe();
                cwe.setCweId(cweId);
                cwe.setName(cweName);
                return cwe;
            }
        }
        return null;
    }

    /**
     * Lookups a CWE from the internal CWE dictionary. This method
     * does not query the database, but will return a Cwe object useful
     * for JSON serialization, but not for persistence.
     * @param cweId the cwe id to lookup
     * @return a Cwe object
     * @since 4.5.0
     */
    public Cwe lookup(final Integer cweId) {
        if (cweId != null) {
            final String cweName = CWE_DICTIONARY.get(cweId);
            if (cweName != null) {
                final Cwe cwe = new Cwe();
                cwe.setCweId(cweId);
                cwe.setName(cweName);
                return cwe;
            }
        }
        return null;
    }

    /**
     * Resolves a CWE by its string representation.
     * This method performs a query against the database and
     * returns a persisted Cwe object.
     * @param cweString the string to resolve
     * @return a Cwe object
     * @since 3.0.0
     */
    public Cwe resolve(final ICweService qm, final String cweString) {
        final Integer cweId = parseCweString(cweString);
        return (cweId != null) ? qm.getCweById(cweId) : null;
    }

    /**
     * Parses a CWE string returning the CWE ID, or null.
     * @param cweString the string to parse
     * @return a Cwe object
     */
    public Integer parseCweString(final String cweString) {
        if (StringUtils.isNotBlank(cweString)) {
            final String string = cweString.trim();
            String lookupString = "";
            if (string.startsWith("CWE-") && string.contains(" ")) {
                // This is likely to be in the following format:
                // CWE-264 Permissions, Privileges, and Access Controls
                lookupString = string.substring(4, string.indexOf(" "));
            } else if (string.startsWith("CWE-") && string.length() < 9) {
                // This is likely to be in the following format:
                // CWE-264
                lookupString = string.substring(4);
            } else if (string.length() < 5) {
                // This is likely to be in the following format:
                // 264
                lookupString = string;
            }
            try {
                return Integer.valueOf(lookupString);
            } catch (NumberFormatException e) {
                // throw it away
            }
        }
        return null;
    }
}
