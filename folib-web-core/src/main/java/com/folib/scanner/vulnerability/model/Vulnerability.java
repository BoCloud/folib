/*
 * Folib - [新一代AI制品仓库]
 * Copyright (C) 2025 bocloud.com.cn <folib@beyondcent.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * 本程序是自由软件：您可依据GNU通用公共许可证（GPL-3.0+）条款重新发布和修改，
 * 但禁止任何形式的商业售卖行为（包括但不限于：直接销售、捆绑销售、云服务商用）。
 *
 * This program is distributed WITHOUT ANY WARRANTY.
 * Commercial sale of this software is expressly prohibited.
 *
 * For license details, see: https://www.gnu.org/licenses/gpl-3.0.html
 * 商业授权咨询请联系：folib@beyondcent.com
 */
package com.folib.scanner.vulnerability.model;


import com.fasterxml.jackson.annotation.JsonGetter;
import com.fasterxml.jackson.annotation.JsonSetter;
import com.folib.scanner.enums.Severity;
import com.folib.scanner.vulnerability.VulnerabilityUtil;
import com.folib.scanner.vulnerability.resolver.CweResolver;
import lombok.AllArgsConstructor;
import lombok.NoArgsConstructor;
import org.apache.commons.lang3.StringUtils;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.*;
import java.util.stream.Collectors;


@AllArgsConstructor
@NoArgsConstructor
public class Vulnerability implements Serializable {

    private static final long serialVersionUID = -3002699553847728904L;


    /**
     * 定义 Dependency-Track 支持的漏洞数据源。
     */
    public enum Source {
        NVD,      // National Vulnerability Database
        NPM,      // NPM Public Advisories - NEED TO KEEP FOR LEGACY PURPOSES
        GITHUB,   // GitHub Security Advisories
        VULNDB,   // VulnDB from Risk Based Security
        OSSINDEX, // Sonatype OSS Index
        RETIREJS, // Retire.js
        INTERNAL,  // Internally-managed (and manually entered) vulnerability
        OSV, // Google OSV Advisories
        SNYK;    // Snyk Purl Vulnerability

        public static boolean isKnownSource(String source) {
            return Arrays.stream(values()).anyMatch(enumSource -> enumSource.name().equalsIgnoreCase(source));
        }
    }


    private Long id;

    private String vulnId;

    private String name;

    private String source;

    private String friendlyVulnId;

    private String title;

    private String subTitle;

    private String description;

    private String zhDescription;

    private String detail;

    private String recommendation;

    private String references;

    private String credits;

    private Date created;


    private Date published;

    private Date updated;

    private List<Integer> cwes;


    private BigDecimal cvssV2BaseScore;


    private BigDecimal cvssV2ImpactSubScore;


    private BigDecimal cvssV2ExploitabilitySubScore;

    private String cvssV2Vector;


    private BigDecimal cvssV3BaseScore;


    private BigDecimal cvssV3ImpactSubScore;


    private BigDecimal cvssV3ExploitabilitySubScore;

    private String cvssV3Vector;


    private BigDecimal owaspRRLikelihoodScore;


    private BigDecimal owaspRRTechnicalImpactScore;


    private BigDecimal owaspRRBusinessImpactScore;

    private String owaspRRVector;

    private Severity severity;

    private String vulnerableVersions;

    private String patchedVersions;

    private List<VulnerableSoftware> vulnerableSoftware;

    private BigDecimal epssScore;

    private BigDecimal epssPercentile;

    private String cnvId;

    //private List<Component> components;
    //private List<ServiceComponent> serviceComponents;
    //private List<AffectedComponent> affectedComponents;



    private String uuid;

    private transient int affectedProjectCount;

    // TODO: 2023/11/16
    //private transient FindingAttribution findingAttribution;
// TODO: 2023/11/16
    //private transient List<AffectedComponent> affectedComponents;
// TODO: 2023/11/16
    private transient List<VulnerabilityAlias> aliases;
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    /**
     * Returns the value of the severity field (if specified), otherwise, will
     * return the severity based on the numerical CVSS or OWASP score.
     *
     * This method properly accounts for vulnerabilities that may have a subset or all of (CVSSv2, CVSSv3, OWASP RR)
     * score. The highest severity is returned.
     * @return the severity of the vulnerability
     * @see VulnerabilityUtil#getSeverity(BigDecimal, BigDecimal, BigDecimal, BigDecimal, BigDecimal)
     */
    public Severity getSeverity() {
        return (this.severity != null) ? severity : VulnerabilityUtil.getSeverity(cvssV2BaseScore, cvssV3BaseScore, owaspRRLikelihoodScore, owaspRRTechnicalImpactScore, owaspRRBusinessImpactScore);
    }

    /**
     * Sets the severity. This should only be set if CVSSv2, CVSSv3 or OWASP RR scores
     * are not used.
     * @param severity the severity of the vulnerability
     */
    public void setSeverity(Severity severity) {
        cvssV2BaseScore = null;
        cvssV2ImpactSubScore = null;
        cvssV2ExploitabilitySubScore = null;
        cvssV2Vector = null;
        cvssV3BaseScore = null;
        cvssV3ImpactSubScore = null;
        cvssV3ExploitabilitySubScore = null;
        cvssV3Vector = null;
        owaspRRLikelihoodScore = null;
        owaspRRBusinessImpactScore = null;
        owaspRRTechnicalImpactScore = null;
        this.severity = severity;
    }

    public String getVulnId() {
        return vulnId;
    }

    public void setVulnId(String vulnId) {
        this.vulnId = vulnId;
    }

    public String getName() {
        return name;
    }
    public void setName(String name) {
        this.name = name;
    }
    public String getFriendlyVulnId() {
        return friendlyVulnId;
    }

    public void setFriendlyVulnId(String friendlyVulnId) {
        this.friendlyVulnId = friendlyVulnId;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    public String getZhDescription() {
        return zhDescription;
    }

    public void setZhDescription(String zhDescription) {
        this.zhDescription = zhDescription;
    }

    public String getRecommendation() {
        return recommendation;
    }

    public String getDetail() {
        return detail;
    }

    public void setDetail(String detail) {
        this.detail = detail;
    }

    public void setRecommendation(String recommendation) {
        this.recommendation = recommendation;
    }

    public String getReferences() {
        return references;
    }

    public void setReferences(String references) {
        this.references = references;
    }

    public String getCredits() {
        return credits;
    }

    public void setCredits(String credits) {
        this.credits = credits;
    }

    public Date getCreated() {
        return created;
    }

    public void setCreated(Date created) {
        this.created = created;
    }

    public Date getPublished() {
        return published;
    }

    public void setPublished(Date published) {
        this.published = published;
    }

    public Date getUpdated() {
        return updated;
    }

    public void setUpdated(Date updated) {
        this.updated = updated;
    }

    public String getVulnerableVersions() {
        return vulnerableVersions;
    }

    public void setVulnerableVersions(String vulnerableVersions) {
        this.vulnerableVersions = vulnerableVersions;
    }

    public String getPatchedVersions() {
        return patchedVersions;
    }

    public void setPatchedVersions(String patchedVersions) {
        this.patchedVersions = patchedVersions;
    }

    public String getSource() {
        return source;
    }

    public void setSource(String source) {
        this.source = source;
    }

    public void setSource(Source source) {
        this.source = source.name();
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public String getSubTitle() {
        return subTitle;
    }

    public void setSubTitle(String subTitle) {
        this.subTitle = subTitle;
    }

    /**
     * Setter for keeping the REST API backwards-compatible.
     * Will be removed in v5.
     *
     * @deprecated Use {@link #getCwes()} instead
     * @return The first {@link Cwe} returned by {@link #getCwes()}, or {@code null} if no {@link Cwe}s are set.
     */
    @JsonGetter("cwe")
    public Cwe getCwe() {
        if (cwes == null || cwes.isEmpty()) {
            return null;
        }

        return CweResolver.getInstance().lookup(cwes.get(0));
    }

    /**
     * Setter for keeping the REST API backwards-compatible.
     * Will be removed in v5.
     *
     * @deprecated Use {@link #setCwes(List)} instead
     * @param cwe The {@link Cwe} to set
     */
    @JsonSetter("cwe")
    public void setCwe(final Cwe cwe) {
        if (cwe != null) {
            setCwes(List.of(cwe.getCweId()));
        }
    }

    public List<Integer> getCwes() {
        return cwes;
    }

    public void setCwes(List<Integer> cwes) {
        if (cwes == null) {
            this.cwes = null;
        } else {
            this.cwes = cwes.stream()
                    .filter(Objects::nonNull).collect(Collectors.toList());
        }
    }

    public void setCwes(String cwes) {
        //这边添加支持String类型转成数组，数据库查询实体转换需要
        if (cwes == null || StringUtils.isBlank(cwes)) {
            this.cwes = null;
        }else{
            final List<Integer> collection = new ArrayList<>();
            for (String s : cwes.split(",")) {
                try {
                    collection.add(Integer.valueOf(s));
                } catch (NumberFormatException e) {
                }
            }
            this.cwes = collection;
        }

    }

    public void addCwe(Integer cweId) {
        if (cweId == null) {
            return;
        }
        if (this.cwes == null) {
            this.cwes = new ArrayList<>();
        }
        this.cwes.add(cweId);
    }

    public void addCwe(Cwe cwe) {
        if (cwe == null) {
            return;
        }
        if (this.cwes == null) {
            this.cwes = new ArrayList<>();
            this.cwes.add(cwe.getCweId());
        } else {
            if (!this.cwes.contains(cwe.getCweId())) {
                this.cwes.add(cwe.getCweId());
            }
        }
    }

    public BigDecimal getCvssV2BaseScore() {
        return cvssV2BaseScore;
    }

    public void setCvssV2BaseScore(BigDecimal cvssV2BaseScore) {
        this.cvssV2BaseScore = cvssV2BaseScore;
    }

    public BigDecimal getCvssV2ImpactSubScore() {
        return cvssV2ImpactSubScore;
    }

    public void setCvssV2ImpactSubScore(BigDecimal cvssV2ImpactSubScore) {
        this.cvssV2ImpactSubScore = cvssV2ImpactSubScore;
    }

    public BigDecimal getCvssV2ExploitabilitySubScore() {
        return cvssV2ExploitabilitySubScore;
    }

    public void setCvssV2ExploitabilitySubScore(BigDecimal cvssV2ExploitabilitySubScore) {
        this.cvssV2ExploitabilitySubScore = cvssV2ExploitabilitySubScore;
    }

    public String getCvssV2Vector() {
        return cvssV2Vector;
    }

    public void setCvssV2Vector(String cvssV2Vector) {
        this.cvssV2Vector = cvssV2Vector;
    }

    public BigDecimal getCvssV3BaseScore() {
        return cvssV3BaseScore;
    }

    public void setCvssV3BaseScore(BigDecimal cvssV3BaseScore) {
        this.cvssV3BaseScore = cvssV3BaseScore;
    }

    public BigDecimal getCvssV3ImpactSubScore() {
        return cvssV3ImpactSubScore;
    }

    public void setCvssV3ImpactSubScore(BigDecimal cvssV3ImpactSubScore) {
        this.cvssV3ImpactSubScore = cvssV3ImpactSubScore;
    }

    public BigDecimal getCvssV3ExploitabilitySubScore() {
        return cvssV3ExploitabilitySubScore;
    }

    public void setCvssV3ExploitabilitySubScore(BigDecimal cvssV3ExploitabilitySubScore) {
        this.cvssV3ExploitabilitySubScore = cvssV3ExploitabilitySubScore;
    }

    public String getCvssV3Vector() {
        return cvssV3Vector;
    }

    public void setCvssV3Vector(String cvssV3Vector) {
        this.cvssV3Vector = cvssV3Vector;
    }

    public BigDecimal getEpssScore() {
        return epssScore;
    }

    public void setEpssScore(BigDecimal epssScore) {
        this.epssScore = epssScore;
    }

    public BigDecimal getEpssPercentile() {
        return epssPercentile;
    }

    public void setEpssPercentile(BigDecimal epssPercentile) {
        this.epssPercentile = epssPercentile;
    }

    public List<VulnerableSoftware> getVulnerableSoftware() {
        return vulnerableSoftware;
    }

    public void setVulnerableSoftware(List<VulnerableSoftware> vulnerableSoftware) {
        this.vulnerableSoftware = vulnerableSoftware;
    }

    //public List<Component> getComponents() {
    //    return components;
    //}
    //
    //public void setComponents(List<Component> components) {
    //    this.components = components;
    //}
    //
    //public List<ServiceComponent> getServiceComponents() {
    //    return serviceComponents;
    //}
    //
    //public void setServiceComponents(List<ServiceComponent> serviceComponents) {
    //    this.serviceComponents = serviceComponents;
    //}

    public String getUuid() {
        return uuid;
    }

    public void setUuid(String uuid) {
        this.uuid = uuid;
    }

    public int getAffectedProjectCount() {
        return affectedProjectCount;
    }

    public void setAffectedProjectCount(int affectedProjectCount) {
        this.affectedProjectCount = affectedProjectCount;
    }





    public List<VulnerabilityAlias> getAliases() {
        return aliases;
    }

    public void setAliases(List<VulnerabilityAlias> aliases) {
        this.aliases = aliases;
    }

    public BigDecimal getOwaspRRLikelihoodScore() {
        return owaspRRLikelihoodScore;
    }

    public void setOwaspRRLikelihoodScore(BigDecimal owaspRRLikelihoodScore) {
        this.owaspRRLikelihoodScore = owaspRRLikelihoodScore;
    }

    public BigDecimal getOwaspRRTechnicalImpactScore() {
        return owaspRRTechnicalImpactScore;
    }

    public void setOwaspRRTechnicalImpactScore(BigDecimal owaspRRTechnicalImpactScore) {
        this.owaspRRTechnicalImpactScore = owaspRRTechnicalImpactScore;
    }

    public BigDecimal getOwaspRRBusinessImpactScore() {
        return owaspRRBusinessImpactScore;
    }

    public void setOwaspRRBusinessImpactScore(BigDecimal owaspRRBusinessImpactScore) {
        this.owaspRRBusinessImpactScore = owaspRRBusinessImpactScore;
    }

    public String getOwaspRRVector() {
        return owaspRRVector;
    }

    public void setOwaspRRVector(String owaspRRVector) {
        this.owaspRRVector = owaspRRVector;
    }

    //public List<AffectedComponent> getAffectedComponents() {
    //    return affectedComponents;
    //}
    //
    //public void setAffectedComponents(List<AffectedComponent> affectedComponents) {
    //    this.affectedComponents = affectedComponents;
    //}

    public String getCnvId() {
       return this.cnvId;
    }

    public void setCnvId(String cnvId) {
        this.cnvId = cnvId;
    }
}
