<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.folib.mapper.VulnerabilityDatabaseMapper">

    <resultMap id="ListMap" type="com.folib.forms.vulnerability.VulnerabilityDatabaseTableForm">
        <id property="id" column="id"/>
        <result property="cve" column="cve"/>
        <result property="severity" column="severity"/>
        <result property="cvssScore" column="cvssScore"/>
        <collection property="cweList" column="id" javaType="java.util.List" ofType="java.lang.String" select="selectCweList">
        </collection>
    </resultMap>

    <resultMap id="DetailMap" type="com.folib.forms.vulnerability.VulnerabilityDatabaseForm">
        <id property="id" column="id"/>
        <result property="cve" column="cve"/>
        <result property="severity" column="severity"/>
        <result property="description" column="description"/>
        <result property="v2Severity" column="v2Severity"/>
        <result property="v2ExploitabilityScore" column="v2ExploitabilityScore"/>
        <result property="v2ImpactScore" column="v2ImpactScore"/>
        <result property="v2AcInsufInfo" column="v2AcInsufInfo"/>
        <result property="v2ObtainAllPrivilege" column="v2ObtainAllPrivilege"/>
        <result property="v2ObtainUserPrivilege" column="v2ObtainUserPrivilege"/>
        <result property="v2ObtainOtherPrivilege" column="v2ObtainOtherPrivilege"/>
        <result property="v2UserInteractionRequired" column="v2UserInteractionRequired"/>
        <result property="v2Score" column="v2Score"/>
        <result property="v2AccessVector" column="v2AccessVector"/>
        <result property="v2AccessComplexity" column="v2AccessComplexity"/>
        <result property="v2Authentication" column="v2Authentication"/>
        <result property="v2ConfidentialityImpact" column="v2ConfidentialityImpact"/>
        <result property="v2IntegrityImpact" column="v2IntegrityImpact"/>
        <result property="v2AvailabilityImpact" column="v2AvailabilityImpact"/>
        <result property="v2Version" column="v2Version"/>
        <result property="v3ExploitabilityScore" column="v3ExploitabilityScore"/>
        <result property="v3ImpactScore" column="v3ImpactScore"/>
        <result property="v3AttackVector" column="v3AttackVector"/>
        <result property="v3AttackComplexity" column="v3AttackComplexity"/>
        <result property="v3PrivilegesRequired" column="v3PrivilegesRequired"/>
        <result property="v3UserInteraction" column="v3UserInteraction"/>
        <result property="v3Scope" column="v3Scope"/>
        <result property="v3ConfidentialityImpact" column="v3ConfidentialityImpact"/>
        <result property="v3IntegrityImpact" column="v3IntegrityImpact"/>
        <result property="v3AvailabilityImpact" column="v3AvailabilityImpact"/>
        <result property="v3BaseScore" column="v3BaseScore"/>
        <result property="v3BaseSeverity" column="v3BaseSeverity"/>
        <result property="v3Version" column="v3Version"/>
        <collection property="cweList" columnPrefix="cwe_" javaType="java.util.List" ofType="java.lang.String">
            <result column="id"/>
        </collection>
        <collection property="references" columnPrefix="refer_" javaType="java.util.List" ofType="java.lang.String">
            <result column="url"/>
        </collection>
    </resultMap>

    <select id="selectList" resultMap="ListMap">
        SELECT
        v.id,
        v.cve,
        IF
        ( ISNULL( v.v3BaseSeverity ), v.v2Severity, v.v3BaseSeverity ) severity,
        IF
        ( ISNULL( v.v3BaseScore ), v.v2Score, v.v3BaseScore ) cvssScore
        FROM
        vulnerability v
        <where>
            <if test="cve != null and cve != ''">
                v.cve = #{cve}
            </if>
        </where>
        ORDER BY v.cve desc
    </select>

    <select id="selectCweList" resultType="java.lang.String">
        SELECT cwe FROM cweEntry WHERE cveid = #{id}
    </select>

    <select id="selectOneVulnerabilityDatabase" resultMap="DetailMap">
        SELECT
        v.*,
        c.cwe cwe_id,
        r.url refer_url,
        IF
        ( ISNULL( v.v3BaseSeverity ), v.v2Severity, v.v3BaseSeverity ) severity
        FROM
        vulnerability v
        LEFT JOIN cweEntry c ON c.cveid = v.id
        LEFT JOIN reference r ON r.cveid = v.id
        WHERE
            v.cve = #{cve}
    </select>

</mapper>